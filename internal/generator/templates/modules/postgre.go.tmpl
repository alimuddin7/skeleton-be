package postgre

import (
	"context"
	"fmt"
	"{{.ProjectName}}/configs"
	"{{.ProjectName}}/helpers"
	hModels "{{.ProjectName}}/helpers/models"
	"github.com/rs/zerolog"
	"gorm.io/driver/postgres"
	"gorm.io/gorm"
	gormlogger "gorm.io/gorm/logger"
	"time"
)

type PostgreDatabase interface {
	HealthCheck(ctx context.Context) hModels.DataHealthCheck
}

type postgreDatabase struct {
	Db   *gorm.DB
	Logs zerolog.Logger
}

func InitializePostgreDatabase(conn *gorm.DB, log zerolog.Logger) PostgreDatabase {
	return &postgreDatabase{
		Db:   conn,
		Logs: log,
	}
}

func ConnectPostgre(log zerolog.Logger) *gorm.DB {
	conf := configs.Cfg.Database.PostgreSQL
	dsn := fmt.Sprintf("host=%s user=%s password=%s dbname=%s port=%d sslmode=%s TimeZone=Asia/Jakarta",
		conf.Host, conf.User, conf.Pass, conf.Database, conf.Port, conf.SSLMode)
	db, err := gorm.Open(postgres.Open(dsn), &gorm.Config{
		Logger: helpers.NewGormLogger(helpers.GormLoggerOptions{
			Logger:                    log,
			LogLevel:                  gormlogger.Info,
			IgnoreRecordNotFoundError: true,
			SlowThreshold:             200 * time.Millisecond,
		}),
	})
	if err != nil {
		log.Error().Err(err).Msg("Error open postgres connection")
		panic("Error open postgres connection")
	}
	return db
}

func (p *postgreDatabase) HealthCheck(ctx context.Context) hModels.DataHealthCheck {
	res := hModels.DataHealthCheck{
		ServiceName: "PostgreSQL Database",
		StatusCode:  200,
	}
	
	sqlDB, err := p.Db.DB()
	if err != nil {
		p.Logs.Error().Ctx(ctx).Err(err).Msg("Failed to get SQL DB")
		res.StatusCode = 500
		res.AdditionalData = err.Error()
		return res
	}
	
	if err := sqlDB.Ping(); err != nil {
		p.Logs.Error().Ctx(ctx).Err(err).Msg("PostgreSQL ping failed")
		res.StatusCode = 500
		res.AdditionalData = err.Error()
		return res
	}
	
	return res
}
